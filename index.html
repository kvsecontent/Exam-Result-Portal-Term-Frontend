<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Portal</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 2px solid #3f51b5;
        }
        
        .header {
            background-color: #3f51b5;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .search-section {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        input[type="text"] {
            padding: 10px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        
        button:hover {
            background-color: #303f9f;
        }
        
        .result-card {
            display: none;
            padding: 15px;
        }
        
        .school-info {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .school-logo {
            width: 100px;
            height: 80px;
            margin: 0 auto;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
        }
        
        .school-info h2 {
            margin: 10px 0 5px;
            font-size: 18px;
        }
        
        .student-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
        
        .student-info-item {
            flex: 1;
            min-width: 250px;
        }
        
        .student-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .exam-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .exam-info p {
            margin: 5px 0;
        }
        
        .subjects-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
            table-layout: fixed;
        }
        
        .subjects-table th, .subjects-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .subjects-table th {
            background-color: #f5f5f5;
        }
        
        .grade-A, .grade-A\+ { color: #4CAF50; font-weight: bold; }
        .grade-B, .grade-B\+ { color: #2196F3; font-weight: bold; }
        .grade-C, .grade-C\+ { color: #FF9800; font-weight: bold; }
        .grade-D, .grade-D\+ { color: #FF9800; font-weight: bold; }
        .grade-E { color: #FF7043; font-weight: bold; }
        .grade-F { color: #F44336; font-weight: bold; }
        
        .summary {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .total-section, .result-section {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin: 5px;
        }
        
        .result-section {
            text-align: center;
        }
        
        .pass {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
        }
        
        .fail {
            color: #F44336;
            font-size: 20px;
            font-weight: bold;
        }
        
        .signature-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .signature {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 0 10px;
        }
        
        .signature-image {
            max-width: 120px;
            height: 50px;
            margin: 5px auto;
            display: block;
        }
        
        .error-message {
            color: #F44336;
            text-align: center;
            padding: 15px;
            display: none;
        }
        
        .print-button {
            text-align: center;
            margin: 15px 0;
        }
        
        .disclaimer {
            text-align: center;
            margin: 30px auto 15px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 10px;
            max-width: 90%;
            font-family: 'Times New Roman', Times, serif;
            position: relative;
            clear: both;
            display: block;
        }
        
        .disclaimer p {
            text-align: center;
            margin: 0 auto;
        }
        
        .component-weight {
            font-size: 11px;
            display: block;
            color: #666;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 0;
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .student-info-item {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .student-info p strong {
                width: 150px;
            }
            
            .signature {
                min-width: 100%;
                margin-bottom: 15px;
            }
            
            input[type="text"] {
                width: 100%;
                margin-bottom: 10px;
            }
            
            button {
                width: 100%;
                margin-left: 0;
            }
            
            .subjects-table {
                font-size: 10px;
            }
            
            .subjects-table th, .subjects-table td {
                padding: 3px;
            }
            
            .component-weight {
                font-size: 8px;
            }
        }
        
        /* Basic portrait print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .result-card, .result-card * {
                visibility: visible;
            }
            
            .result-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: 2px solid #3f51b5 !important;
                padding: 15px !important;
                box-sizing: border-box !important;
                background-color: white !important;
            }
            
            .student-info {
                border: 1px solid #000 !important;
            }
            
            .subjects-table th, .subjects-table td {
                border: 1px solid #000 !important;
            }
            
            .total-section, .result-section {
                border: 1px solid #000 !important;
            }
            
            .print-button {
                display: none !important;
            }
            
            .grade-A, .grade-A\+ { color: #4CAF50 !important; }
            .grade-B, .grade-B\+ { color: #2196F3 !important; }
            .grade-C, .grade-C\+ { color: #FF9800 !important; }
            .grade-D, .grade-D\+ { color: #FF9800 !important; }
            .grade-E { color: #FF7043 !important; }
            .grade-F { color: #F44336 !important; }
            
            .disclaimer {
                position: relative !important;
                visibility: visible !important;
                display: block !important;
                margin: 30px auto 15px !important;
                text-align: center !important;
                font-family: 'Times New Roman', Times, serif !important;
                width: 90% !important;
            }
            
            .disclaimer p {
                text-align: center !important;
                margin: 0 auto !important;
                width: 100% !important;
            }
            
            .pass { color: #4CAF50 !important; }
            .fail { color: #F44336 !important; }
            
            @page {
                size: portrait;
                margin: 10mm;
            }
        }
        
        /* Landscape print styles */
        @media print and (min-width: 800px) {
            @page {
                size: landscape;
                margin: 10mm;
            }
        }
        
        /* Debug section */
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Exam Results Portal</h1>
        </div>
        
        <div class="search-section">
            <input type="text" id="rollNumber" placeholder="Enter 5 Digits Admission No.">
            <button onclick="fetchResult()">Get Result</button>
            <button onclick="toggleDebug()" style="background-color: #666;">Debug</button>
        </div>
        
        <div class="error-message" id="errorMessage">
            Student record not found. Please check the Enrollment number and try again.
        </div>
        
        <div class="debug-section" id="debugSection">
            <h3>Debug Information</h3>
            <div id="debugInfo"></div>
        </div>
        
        <div class="result-card" id="resultCard">
            <div class="school-info">
                <div class="school-logo">
                    <img src="https://i.imgur.com/GxoHln6.jpeg" alt="KVS" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h2 id="schoolName">School Name</h2>
                <p>Examination Results <span id="examYear">2024-25</span></p>
            </div>
            
            <div class="student-info">
                <div class="student-info-item">
                    <p><strong>Name:</strong> <span id="studentName">John Doe</span></p>
                    <p><strong>Enrollment No:</strong> <span id="studentRoll">12345</span></p>
                    <p><strong>Date of Birth:</strong> <span id="studentDOB">01/01/2010</span></p>
                </div>
                <div class="student-info-item text-right">
                    <p><strong>Class:</strong> <span id="studentClass">X-A</span></p>
                    <p><strong>Father's Name:</strong> <span id="fatherName">Mr. John Doe Sr.</span></p>
                    <p><strong>Mother's Name:</strong> <span id="motherName">Mrs. Jane Doe</span></p>
                </div>
            </div>
            
            <div class="exam-info">
                <p><strong>Exam:</strong> <span id="examName">Final Term</span></p>
            </div>
            
            <!-- Simple table view -->
            <div id="simpleTableContainer">
                <table class="subjects-table" id="simpleTable">
                    <thead>
                        <tr>
                            <th style="width:40%;">Subject</th>
                            <th style="width:20%;">Max Marks</th>
                            <th style="width:20%;">Marks Obtained</th>
                            <th style="width:20%;">Grade</th>
                        </tr>
                    </thead>
                    <tbody id="simpleTableBody">
                        <!-- Will be filled dynamically -->
                    </tbody>
                </table>
            </div>
            
            <!-- Detailed table view -->
            <div id="detailedTableContainer" style="display:none;">
                <table class="subjects-table" id="detailedTable">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:16%;">Subject</th>
                            <th colspan="6" style="width:60%;">Assessment Components</th>
                            <th rowspan="2" style="width:12%;">Total<br>(100)</th>
                            <th rowspan="2" style="width:12%;">Grade</th>
                        </tr>
                        <tr>
                            <th style="width:10%;">Periodic<br><span class="component-weight">(10)</span></th>
                            <th style="width:10%;">Notebook<br><span class="component-weight">(05)</span></th>
                            <th style="width:10%;">Enrichment<br><span class="component-weight">(05)</span></th>
                            <th style="width:10%;">MDP<br><span class="component-weight">(20)</span></th>
                            <th style="width:10%;">Oral<br><span class="component-weight">(20)</span></th>
                            <th style="width:10%;">Mid-Term<br><span class="component-weight">(40)</span></th>
                        </tr>
                    </thead>
                    <tbody id="detailedTableBody">
                        <!-- Will be filled dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                <div class="total-section">
                    <p><strong>Total Marks:</strong> <span id="totalObtained">0</span>/<span id="totalMax">0</span></p>
                    <p><strong>Percentage:</strong> <span id="percentage">0</span>%</p>
                    <p><strong>Remark:</strong> <span id="cgpa">0.0</span></p>
                </div>
                <div class="result-section">
                    <p><strong>Result</strong></p>
                    <p id="resultStatus" class="pass">PASS</p>
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature" style="visibility: hidden">
                    <!-- Empty space where Class Teacher was -->
                </div>
                <div class="signature">
                    <img id="examInchargeSignature" src="" alt="Exam Incharge Signature" class="signature-image" style="display: none;">
                    <p>Exam I/C</p>
                </div>
            </div>
            
            <div class="disclaimer">
                <p style="text-align: center;"><strong>Disclaimer:</strong> kvsecontent is not responsible for any errors in the online results. These are for immediate reference only and not official mark sheets. Original mark sheets are issued separately by the Vidyalaya.</p>
            </div>
            
            <div class="print-button">
                <button onclick="printResult()" style="background-color: #4CAF50;">Print Result</button>
            </div>
        </div>
    </div>

    <script>
        // API URL
        const API_BASE_URL = 'https://term-exam-result-api.onrender.com';
        
        // Assessment Component Configuration
        const ASSESSMENT_COMPONENTS = [
            { id: 'periodic', name: 'Periodic_Test', displayName: 'Periodic Test', weight: 10 },
            { id: 'notebook', name: 'Notebook_Submission', displayName: 'Notebook', weight: 5 },
            { id: 'enrichment', name: 'Subject_Enrichment', displayName: 'Enrichment', weight: 5 },
            { id: 'mdp', name: 'MDP', displayName: 'MDP', weight: 20 },
            { id: 'oral', name: 'Oral_Test', displayName: 'Oral', weight: 20 },
            { id: 'midterm', name: 'MidTerm_Exam', displayName: 'Mid-Term', weight: 40 }
        ];
        
        // Debug functions
        function addDebug(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<p><strong>${timestamp}:</strong> ${message}</p>`;
            console.log(message);
        }
        
        function toggleDebug() {
            const debugSection = document.getElementById('debugSection');
            debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
        }
        
        function debugObject(label, obj) {
            addDebug(`${label}: ${JSON.stringify(obj)}`);
        }
        
        // Main functions
        async function fetchDataFromBackend(rollNumber) {
            try {
                addDebug(`Fetching data for roll number: ${rollNumber}`);
                const url = `${API_BASE_URL}/api/student/${rollNumber}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Process the data
                    const processedData = processApiData(result.data);
                    return processedData;
                }
                
                return null;
            } catch (error) {
                addDebug(`Error fetching data: ${error.message}`);
                return null;
            }
        }
        
        function processApiData(apiData) {
            // Create a deep copy to avoid modifying the original
            const data = JSON.parse(JSON.stringify(apiData));
            
            addDebug(`Processing API data with ${data.subjects?.length || 0} subjects`);
            
            // Group subjects by their base name (before the underscore)
            const groupedSubjects = {};
            const mainSubjects = [];
            
            if (data.subjects && Array.isArray(data.subjects)) {
                data.subjects.forEach(subject => {
                    // Extract the base subject name and component
                    const parts = subject.name.split('_');
                    const baseSubjectName = parts[0]; // Hindi, English, Math, etc.
                    
                    // Create the subject group if it doesn't exist
                    if (!groupedSubjects[baseSubjectName]) {
                        groupedSubjects[baseSubjectName] = {
                            name: baseSubjectName,
                            maxMarks: 100,
                            components: {},
                            // Initialize with zero, will calculate total later
                            obtained: 0,
                            // Will calculate grade based on total
                            grade: '-'
                        };
                    }
                    
                    // Check which component this is
                    for (const component of ASSESSMENT_COMPONENTS) {
                        if (subject.name.includes(`_${component.name}`)) {
                            groupedSubjects[baseSubjectName].components[component.id] = {
                                marks: subject.obtained || 0
                            };
                            break;
                        }
                    }
                });
                
                // Calculate total marks and grades for each subject
                for (const baseSubjectName in groupedSubjects) {
                    const subject = groupedSubjects[baseSubjectName];
                    let totalMarks = 0;
                    
                    // Sum up all component marks
                    for (const componentId in subject.components) {
                        totalMarks += subject.components[componentId].marks;
                    }
                    
                    subject.obtained = totalMarks;
                    subject.grade = calculateGrade(totalMarks);
                    
                    mainSubjects.push(subject);
                }
                
                // Replace the original subjects with the grouped ones
                data.groupedSubjects = mainSubjects;
                
                addDebug(`Grouped into ${mainSubjects.length} main subjects`);
                debugObject("Grouped subjects", mainSubjects);
            }
            
            return data;
        }
        
        function calculateGrade(marks) {
            if (marks >= 90) return 'A';
            else if (marks >= 80) return 'B';
            else if (marks >= 70) return 'C';
            else if (marks >= 60) return 'D';
            else if (marks >= 50) return 'E';
            else return 'F';
        }
        
        function getGradeClass(grade) {
            const baseGrade = grade.charAt(0);
            return `grade-${baseGrade}`;
        }
        
        function displayResult(data, rollNumber) {
            // Set student info
            document.getElementById('studentName').textContent = data.name;
            document.getElementById('studentRoll').textContent = rollNumber;
            document.getElementById('studentClass').textContent = data.class;
            document.getElementById('schoolName').textContent = data.school;
            document.getElementById('examName').textContent = data.examName;
            
            // Set additional info
            document.getElementById('studentDOB').textContent = data.dob;
            document.getElementById('fatherName').textContent = data.fatherName;
            document.getElementById('motherName').textContent = data.motherName;
            
            // Handle signature
            const signatureImg = document.getElementById('examInchargeSignature');
            if (data.examInchargeSignature) {
                signatureImg.src = data.examInchargeSignature;
                signatureImg.style.display = 'block';
            }
            
            // Determine if we should show detailed or simple view
            const useDetailedView = data.groupedSubjects.some(subject => 
                Object.keys(subject.components).length > 0
            );
            
            // Set up the tables
            const simpleTableContainer = document.getElementById('simpleTableContainer');
            const detailedTableContainer = document.getElementById('detailedTableContainer');
            
            if (useDetailedView) {
                // Show detailed table
                simpleTableContainer.style.display = 'none';
                detailedTableContainer.style.display = 'block';
                
                populateDetailedTable(data.groupedSubjects);
            } else {
                // Show simple table
                simpleTableContainer.style.display = 'block';
                detailedTableContainer.style.display = 'none';
                
                populateSimpleTable(data.groupedSubjects);
            }
            
            // Set summary information
            document.getElementById('totalObtained').textContent = data.totalObtained;
            document.getElementById('totalMax').textContent = data.totalMarks;
            document.getElementById('percentage').textContent = data.percentage;
            document.getElementById('cgpa').textContent = data.cgpa;
            
            // Set result
            document.getElementById('resultStatus').textContent = data.result;
            document.getElementById('resultStatus').className = data.result.toLowerCase().includes('pass') ? 'pass' : 'fail';
        }
        
        function populateSimpleTable(subjects) {
            const tableBody = document.getElementById('simpleTableBody');
            tableBody.innerHTML = '';
            
            addDebug(`Populating simple table with ${subjects.length} subjects`);
            
            subjects.forEach(subject => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = subject.name;
                nameCell.style.textAlign = 'center';
                nameCell.style.width = '40%';
                
                const maxMarksCell = document.createElement('td');
                maxMarksCell.textContent = subject.maxMarks;
                maxMarksCell.style.textAlign = 'center';
                maxMarksCell.style.width = '20%';
                
                const obtainedCell = document.createElement('td');
                obtainedCell.textContent = subject.obtained;
                obtainedCell.style.textAlign = 'center';
                obtainedCell.style.width = '20%';
                
                const gradeCell = document.createElement('td');
                gradeCell.textContent = subject.grade;
                gradeCell.className = getGradeClass(subject.grade);
                gradeCell.style.textAlign = 'center';
                gradeCell.style.width = '20%';
                
                row.appendChild(nameCell);
                row.appendChild(maxMarksCell);
                row.appendChild(obtainedCell);
                row.appendChild(gradeCell);
                
                tableBody.appendChild(row);
            });
        }
        
        function populateDetailedTable(subjects) {
            const tableBody = document.getElementById('detailedTableBody');
            tableBody.innerHTML = '';
            
            addDebug(`Populating detailed table with ${subjects.length} subjects`);
            
            subjects.forEach(subject => {
                const row = document.createElement('tr');
                
                // Add subject name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = subject.name;
                nameCell.style.textAlign = 'center';
                nameCell.style.width = '16%';
                row.appendChild(nameCell);
                
                // Add cells for each component
                ASSESSMENT_COMPONENTS.forEach(component => {
                    const cell = document.createElement('td');
                    const marks = subject.components[component.id]?.marks || '-';
                    cell.textContent = marks;
                    cell.style.textAlign = 'center';
                    cell.style.width = '10%';
                    row.appendChild(cell);
                });
                
                // Add total marks cell
                const totalCell = document.createElement('td');
                totalCell.textContent = subject.obtained;
                totalCell.style.textAlign = 'center';
                totalCell.style.width = '12%';
                row.appendChild(totalCell);
                
                // Add grade cell
                const gradeCell = document.createElement('td');
                gradeCell.textContent = subject.grade;
                gradeCell.className = getGradeClass(subject.grade);
                gradeCell.style.textAlign = 'center';
                gradeCell.style.width = '12%';
                row.appendChild(gradeCell);
                
                tableBody.appendChild(row);
            });
        }
        
        async function fetchResult() {
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const resultCard = document.getElementById('resultCard');
            const errorMessage = document.getElementById('errorMessage');
            
            // Reset display
            resultCard.style.display = 'none';
            errorMessage.style.display = 'none';
            document.getElementById('debugInfo').innerHTML = '';
            
            // Validate input
            if (!rollNumber) {
                errorMessage.textContent = "Please enter an admission number";
                errorMessage.style.display = 'block';
                return;
            }
            
            addDebug(`Starting fetch for roll number: ${rollNumber}`);
            
            // Fetch data from backend
            const data = await fetchDataFromBackend(rollNumber);
            
            if (data) {
                displayResult(data, rollNumber);
                resultCard.style.display = 'block';
                addDebug("Successfully displayed result");
            } else {
                errorMessage.style.display = 'block';
                addDebug("No data found or error occurred");
            }
        }
        
        function printResult() {
            const resultCard = document.getElementById('resultCard');
            if (resultCard.style.display === 'none') {
                alert('Please search for a student result first');
                return;
            }
            
            window.print();
        }
        
        // Add event listener for Enter key on roll number input
        document.getElementById('rollNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchResult();
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Exam Results Portal loaded");
        });
    </script>
</body>
</html>
