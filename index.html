<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Results Portal</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 2px solid #3f51b5;
        }
        
        .header {
            background-color: #3f51b5;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .search-section {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        input[type="text"] {
            padding: 10px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3f51b5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        
        button:hover {
            background-color: #303f9f;
        }
        
        .result-card {
            display: none;
            padding: 15px;
        }
        
        .school-info {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .school-logo {
            width: 100px;
            height: 80px;
            margin: 0 auto;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
        }
        
        .school-info h2 {
            margin: 10px 0 5px;
            font-size: 18px;
        }
        
        .student-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
        
        .student-info-item {
            flex: 1;
            min-width: 250px;
        }
        
        .student-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .text-right {
            text-align: right;
        }
        
        .exam-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .exam-info p {
            margin: 5px 0;
        }
        
        .subjects-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .subjects-table th, .subjects-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .subjects-table th {
            background-color: #f5f5f5;
        }
        
        .subjects-table th:first-child, .subjects-table td:first-child {
            text-align: center;
        }
        
        .grade-A, .grade-A\+ { color: #4CAF50; font-weight: bold; }
        .grade-B, .grade-B\+ { color: #2196F3; font-weight: bold; }
        .grade-C, .grade-C\+ { color: #FF9800; font-weight: bold; }
        .grade-D, .grade-D\+ { color: #FF9800; font-weight: bold; }
        .grade-E { color: #FF7043; font-weight: bold; }
        .grade-F { color: #F44336; font-weight: bold; }
        
        .summary {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .total-section, .result-section {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin: 5px;
        }
        
        .result-section {
            text-align: center;
        }
        
        .pass {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
        }
        
        .fail {
            color: #F44336;
            font-size: 20px;
            font-weight: bold;
        }
        
        .signature-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .signature {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 0 10px;
        }
        
        .signature-image {
            max-width: 120px;
            height: 50px;
            margin: 5px auto;
            display: block;
        }
        
        .error-message {
            color: #F44336;
            text-align: center;
            padding: 15px;
            display: none;
        }
        
        .print-button {
            text-align: center;
            margin: 15px 0;
        }
        
        .disclaimer {
            text-align: center;
            margin: 30px auto 15px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 10px;
            max-width: 90%;
            font-family: 'Times New Roman', Times, serif;
            position: relative;
            clear: both;
            display: block;
        }
        
        .disclaimer p {
            text-align: center;
            margin: 0 auto;
        }

        /* Added styles for subject components that better match original aesthetic */
        .component-list {
            padding-left: 20px;
            margin: 3px 0;
            font-size: 12px;
            color: #555;
            border-left: 3px solid #eee;
        }
        
        .component-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            padding: 2px 0;
        }
        
        .component-name {
            flex: 3;
            padding-right: 10px;
        }
        
        .component-marks {
            flex: 1;
            text-align: right;
            font-weight: normal;
        }
        
        /* Table responsive styling for mobile */
        #detailedTableContainer {
            width: 100%;
            overflow-x: auto;
            position: relative;
        }
        
        #detailedTableContainer::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.1));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #detailedTableContainer.has-overflow::after {
            opacity: 1;
        }
        
        #detailedTable {
            min-width: 100%;
            width: max-content;
        }
        
        .subjects-table th, .subjects-table td {
            min-width: 60px;
            max-width: 120px;
            white-space: normal;
            word-wrap: break-word;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 0;
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .student-info-item {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .student-info p strong {
                width: 150px;
            }
            
            .signature {
                min-width: 100%;
                margin-bottom: 15px;
            }
            
            input[type="text"] {
                width: 100%;
                margin-bottom: 10px;
            }
            
            button {
                width: 100%;
                margin-left: 0;
            }
            
            .subjects-table {
                font-size: 10px;
            }
            
            .subjects-table th, .subjects-table td {
                padding: 3px;
                min-width: 50px;
            }
            
            .component-weight {
                font-size: 8px;
            }
            
            /* Show swipe hint on mobile */
            .swipe-hint {
                display: block;
            }
            
            /* Adjust detailed table on mobile */
            #detailedTable th, #detailedTable td {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 80px;
            }
            
            #detailedTable th:first-child, 
            #detailedTable td:first-child {
                position: sticky;
                left: 0;
                background-color: #fff;
                z-index: 1;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
        }
        
        /* Basic portrait print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .result-card, .result-card * {
                visibility: visible;
            }
            
            .result-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: 2px solid #3f51b5 !important;
                padding: 15px !important;
                box-sizing: border-box !important;
                background-color: white !important;
            }
            
            .student-info {
                border: 1px solid #000 !important;
            }
            
            .subjects-table th, .subjects-table td {
                border: 1px solid #000 !important;
            }
            
            .total-section, .result-section {
                border: 1px solid #000 !important;
            }
            
            .print-button {
                display: none !important;
            }
            
            .grade-A, .grade-A\+ { color: #4CAF50 !important; }
            .grade-B, .grade-B\+ { color: #2196F3 !important; }
            .grade-C, .grade-C\+ { color: #FF9800 !important; }
            .grade-D, .grade-D\+ { color: #FF9800 !important; }
            .grade-E { color: #FF7043 !important; }
            .grade-F { color: #F44336 !important; }
            
            .disclaimer {
                position: relative !important;
                visibility: visible !important;
                display: block !important;
                margin: 30px auto 15px !important;
                text-align: center !important;
                font-family: 'Times New Roman', Times, serif !important;
                width: 90% !important;
            }
            
            .disclaimer p {
                text-align: center !important;
                margin: 0 auto !important;
                width: 100% !important;
            }
            
            .pass { color: #4CAF50 !important; }
            .fail { color: #F44336 !important; }
            
            @page {
                size: portrait;
                margin: 10mm;
            }
        }
        
        /* Landscape print styles - will be applied when body has 'print-landscape' class */
        body.print-landscape {
            width: auto;
            height: auto;
        }
        
        @media print and (min-width: 800px) {
            body.print-landscape .subjects-table {
                font-size: 10px !important;
            }
            
            body.print-landscape .subjects-table th, 
            body.print-landscape .subjects-table td {
                padding: 4px !important;
            }
            
            @page {
                size: landscape;
                margin: 10mm;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Exam Results Portal</h1>
        </div>
        
        <div class="search-section">
            <input type="text" id="rollNumber" placeholder="Enter 5 Digits Admission No.">
            <button onclick="fetchResult()">Get Result</button>
        </div>
        
        <div class="error-message" id="errorMessage">
            Student record not found. Please check the Enrollment number and try again.
        </div>
        
        <div class="result-card" id="resultCard">
            <div class="school-info">
                <div class="school-logo">
                    <img src="https://i.imgur.com/GxoHln6.jpeg" alt="KVS" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h2 id="schoolName">School Name</h2>
                <p>Examination Results <span id="examYear"></span></p>
            </div>
            
            <div class="student-info">
                <div class="student-info-item">
                    <p><strong>Name:</strong> <span id="studentName">John Doe</span></p>
                    <p><strong>Enrollment No:</strong> <span id="studentRoll">12345</span></p>
                    <p><strong>Date of Birth:</strong> <span id="studentDOB">01/01/2010</span></p>
                </div>
                <div class="student-info-item text-right">
                    <p><strong>Class:</strong> <span id="studentClass">X-A</span></p>
                    <p><strong>Father's Name:</strong> <span id="fatherName">Mr. John Doe Sr.</span></p>
                    <p><strong>Mother's Name:</strong> <span id="motherName">Mrs. Jane Doe</span></p>
                </div>
            </div>
            
            <div class="exam-info">
                <p><strong>Exam:</strong> <span id="examName">Final Term</span></p>
            </div>
            
            <!-- Default table with simple columns (will be replaced with detailed one if needed) -->
            <div id="simpleTableContainer">
                <table class="subjects-table" id="simpleTable">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Max Marks</th>
                            <th>Marks Obtained</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody id="simpleTableBody">
                        <!-- Subject marks will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Detailed table with assessment components (initially hidden) -->
            <div id="detailedTableContainer" style="display: none;">
                <div class="swipe-hint">← Swipe to see more columns →</div>
                <table class="subjects-table" id="detailedTable">
                    <!-- Table headers will be created dynamically -->
                    <thead id="detailedTableHead">
                    </thead>
                    <tbody id="detailedTableBody">
                        <!-- Detailed subject marks will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                <div class="total-section">
                    <p><strong>Total Marks:</strong> <span id="totalObtained">0</span>/<span id="totalMax">0</span></p>
                    <p><strong>Percentage:</strong> <span id="percentage">0</span>%</p>
                    <p><strong>Remark:</strong> <span id="cgpa">0.0</span></p>
                </div>
                <div class="result-section">
                    <p><strong>Result</strong></p>
                    <p id="resultStatus" class="pass">PASS</p>
                </div>
            </div>
            
            <div class="signature-section">
                <div class="signature" style="visibility: hidden">
                    <!-- Empty space where Class Teacher was -->
                </div>
                <div class="signature">
                    <img id="examInchargeSignature" src="" alt="Exam Incharge Signature" class="signature-image" style="display: none;">
                    <p>Exam I/C</p>
                </div>
            </div>
            
            <div class="disclaimer">
                <p style="text-align: center;"><strong>Disclaimer:</strong> kvsecontent is not responsible for any errors in the online results. These are for immediate reference only and not official mark sheets. Original mark sheets are issued separately by the Vidyalaya.</p>
            </div>
            
            <div class="print-button">
                <button onclick="printResult()" style="background-color: #4CAF50;">Print Result</button>
            </div>
        </div>
    </div>

    <script>
        // Correct API URL
        const API_BASE_URL = 'https://term-exam-result-api.onrender.com'; 
        
        // Google Sheets API settings - replace with your actual values
        const GOOGLE_SHEET_ID = 'YOUR_GOOGLE_SHEET_ID';
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY';
        
        // All data is in Sheet2
        const SHEET_RANGE = 'Sheet2!A:Z'; // Using A:Z to capture all columns

        // Instead of using a predefined list, we'll dynamically detect components
        // by their naming pattern and fetch from Google Sheets

        // Store the data globally
        let studentData = {};
        
        // Flag to check if we need detailed view
        let useDetailedView = false;
        
        // Default school configuration
        const schoolConfig = {
            SchoolName: 'Kendriya Vidyalaya',
            ExamName: 'Term Examination',
            PassingPercentage: 33,
            GradeAMin: 90,
            GradeBMin: 80,
            GradeCMin: 70,
            GradeDMin: 60,
            GradeEMin: 50
        };

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialized');
        });
        
        // Fetch student data from Google Sheets with wide format structure
        async function fetchStudentDataFromGoogleSheet(rollNumber) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${SHEET_RANGE}?key=${GOOGLE_API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Failed to fetch student data from Google Sheets:', response.statusText);
                    return null;
                }
                
                const result = await response.json();
                
                if (!result.values || result.values.length === 0) {
                    console.error('No data found in Google Sheet');
                    return null;
                }
                
                // Get headers from first row - these will include Subject_Component_Obtained and Subject_Component_Max_Marks
                const headers = result.values[0];
                
                // Find the row for this student
                const studentRow = result.values.slice(1).find(row => 
                    row.length > 0 && row[2] === rollNumber // Roll number is in column C (index 2)
                );
                
                if (!studentRow) {
                    console.log('No data found for student:', rollNumber);
                    return null;
                }
                
                // Basic student info is in the first 8 columns
                const studentInfo = {
                    school: studentRow[0] || schoolConfig.SchoolName, // School name (Col A)
                    examName: studentRow[1] || schoolConfig.ExamName, // Exam name (Col B)
                    rollNumber: studentRow[2], // Roll number (Col C)
                    name: studentRow[3] || 'Unknown', // Student name (Col D)
                    dob: studentRow[4] || '', // DOB (Col E)
                    fatherName: studentRow[5] || '', // Father name (Col F)
                    motherName: studentRow[6] || '', // Mother name (Col G)
                    class: studentRow[7] || 'Unknown', // Class (Col H)
                    subjects: []
                };
                
                // Track active components for this student
                const activeComponents = new Set();
                
                // Process subject component columns (starting from column I, index 8)
                // Group subjects by their base name 
                const groupedSubjects = {};
                
                for (let i = 8; i < headers.length; i++) {
                    const columnHeader = headers[i];
                    
                    // Skip empty headers
                    if (!columnHeader) continue;
                    
                    // Check if this is an "Obtained" column by looking for "_Obtained" suffix
                    if (columnHeader.endsWith('_Obtained')) {
                        // Extract subject and component from header
                        // Format is Subject_Component_Obtained
                        const parts = columnHeader.split('_');
                        if (parts.length < 3) continue; // Skip if format is incorrect
                        
                        // Remove "_Obtained" from the end
                        parts.pop();
                        
                        // Last part is the component, everything before is the subject
                        const componentName = parts.pop();
                        const subjectName = parts.join('_');
                        
                        // Look for corresponding Max_Marks column (should be the next column)
                        const maxMarksHeader = headers[i + 1];
                        if (maxMarksHeader && maxMarksHeader === `${subjectName}_${componentName}_Max_Marks`) {
                            // Get the obtained and max marks values
                            const obtained = parseFloat(studentRow[i]) || 0;
                            const maxMarks = parseFloat(studentRow[i + 1]) || 100;
                            
                            // Only add component if it has data (obtained > 0)
                            if (obtained > 0) {
                                // Initialize subject if not already done
                                if (!groupedSubjects[subjectName]) {
                                    groupedSubjects[subjectName] = {
                                        name: subjectName,
                                        maxMarks: 100,
                                        obtained: 0,
                                        components: {},
                                        hasData: false
                                    };
                                }
                                
                                // Add component to subject
                                groupedSubjects[subjectName].components[componentName] = {
                                    marks: obtained,
                                    displayName: COMPONENT_NAMES[componentName]?.displayName || componentName,
                                    weight: COMPONENT_NAMES[componentName]?.weight || maxMarks
                                };
                                
                                // Add to active components
                                activeComponents.add(componentName);
                                groupedSubjects[subjectName].hasData = true;
                                
                                // Add to total obtained for this subject
                                groupedSubjects[subjectName].obtained += obtained;
                            }
                        }
                    }
                }
                
                // Calculate grades and prepare subjects array
                const mainSubjects = [];
                
                for (const subjectName in groupedSubjects) {
                    const subject = groupedSubjects[subjectName];
                    
                    // Calculate grade
                    subject.grade = calculateGrade(subject.obtained);
                    
                    // Only add subjects with data
                    if (subject.hasData) {
                        mainSubjects.push(subject);
                    }
                }
                
                // Check if any subjects have component data to determine table view
                useDetailedView = mainSubjects.length > 0 && activeComponents.size > 0;
                
                // Calculate totals
                let totalObtained = 0;
                let totalMaxMarks = mainSubjects.length * 100; // Each subject has max 100
                
                mainSubjects.forEach(subject => {
                    totalObtained += subject.obtained;
                });
                
                const percentage = totalMaxMarks > 0 ? 
                    ((totalObtained / totalMaxMarks) * 100).toFixed(2) : 0;
                
                // Calculate CGPA (assuming 10-point scale)
                const cgpa = (percentage / 10).toFixed(1);
                
                // Determine pass/fail (default passing is 33%)
                const passingPercentage = parseFloat(schoolConfig.PassingPercentage) || 33;
                const result = percentage >= passingPercentage ? 'PASS' : 'FAIL';
                
                // Add calculated data to student info
                studentInfo.totalObtained = totalObtained;
                studentInfo.totalMarks = totalMaxMarks;
                studentInfo.percentage = percentage;
                studentInfo.cgpa = cgpa;
                studentInfo.result = result;
                studentInfo.hasDetailedView = useDetailedView;
                studentInfo.groupedSubjects = mainSubjects;
                studentInfo.activeComponents = Array.from(activeComponents);
                
                return studentInfo;
            } catch (error) {
                console.error('Error fetching student data from Google Sheets:', error);
                return null;
            }
        }
        
        // Calculate total marks, percentage and result
        function calculateTotals(data) {
            if (!data.processedSubjects || !Array.isArray(data.processedSubjects)) {
                return;
            }
            
            let totalObtained = 0;
            let totalMaxMarks = 0;
            
            data.processedSubjects.forEach(subject => {
                totalObtained += subject.obtained;
                totalMaxMarks += subject.maxMarks;
            });
            
            const percentage = totalMaxMarks > 0 ? 
                ((totalObtained / totalMaxMarks) * 100).toFixed(2) : 0;
            
            // Calculate CGPA (assuming 10-point scale)
            const cgpa = (percentage / 10).toFixed(1);
            
            // Determine pass/fail (default passing is 33%)
            const passingPercentage = parseFloat(schoolConfig.PassingPercentage) || 33;
            const result = percentage >= passingPercentage ? 'PASS' : 'FAIL';
            
            // Add totals to data
            data.totalObtained = totalObtained;
            data.totalMarks = totalMaxMarks;
            data.percentage = percentage;
            data.cgpa = cgpa;
            data.result = result;
        }

        // Try to fetch data from Google Sheets first, fall back to API if needed
        async function fetchStudentData(rollNumber) {
            // Try Google Sheets first
            const googleData = await fetchStudentDataFromGoogleSheet(rollNumber);
            if (googleData) {
                return googleData;
            }
            
            // Fall back to original API if Google Sheets data not found
            console.log("Student not found in Google Sheets, trying API...");
            try {
                const url = `${API_BASE_URL}/api/student/${rollNumber}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Process the data using the same approach as the original code
                    const data = result.data;
                    
                    // Extract all active components for this student
                    const activeComponents = new Set();
                    
                    // Group subjects by their base name (before the underscore)
                    const groupedSubjects = {};
                    const mainSubjects = [];
                    
                    if (data.subjects && Array.isArray(data.subjects)) {
                        // First pass - identify all components and group subjects
                        data.subjects.forEach(subject => {
                            // Extract the base subject name and component
                            const parts = subject.name.split('_');
                            const baseSubjectName = parts[0]; // Hindi, English, Math, etc.
                            
                            // Only process if there's a component (parts > 1)
                            if (parts.length > 1) {
                                const componentName = subject.name.substring(baseSubjectName.length + 1);
                                
                                // Create the subject group if it doesn't exist
                                if (!groupedSubjects[baseSubjectName]) {
                                    groupedSubjects[baseSubjectName] = {
                                        name: baseSubjectName,
                                        maxMarks: 100,
                                        components: {},
                                        obtained: 0,
                                        grade: '-',
                                        hasData: false
                                    };
                                }
                                
                                // Add the component to the subject and track it
                                const marks = subject.obtained || 0;
                                groupedSubjects[baseSubjectName].components[componentName] = {
                                    marks: marks,
                                    displayName: COMPONENT_NAMES[componentName]?.displayName || componentName,
                                    weight: COMPONENT_NAMES[componentName]?.weight || 0
                                };
                                
                                // If the component has marks > 0, add it to active components
                                if (marks > 0) {
                                    activeComponents.add(componentName);
                                    groupedSubjects[baseSubjectName].hasData = true;
                                    groupedSubjects[baseSubjectName].obtained += marks;
                                }
                            }
                        });
                        
                        // Calculate grades for each subject
                        for (const baseSubjectName in groupedSubjects) {
                            const subject = groupedSubjects[baseSubjectName];
                            if (subject.hasData) {
                                subject.grade = calculateGrade(subject.obtained);
                                mainSubjects.push(subject);
                            }
                        }
                        
                        // Check if any subjects have component data
                        useDetailedView = mainSubjects.length > 0 && activeComponents.size > 0;
                    }
                    
                    // Add processed data to the result
                    data.hasDetailedView = useDetailedView;
                    data.groupedSubjects = mainSubjects;
                    data.activeComponents = Array.from(activeComponents);
                    
                    // Ensure basic fields are present
                    if (!data.school) {
                        data.school = schoolConfig.SchoolName;
                    }
                    
                    if (!data.examName) {
                        data.examName = schoolConfig.ExamName;
                    }
                    
                    return data;
                }
                return null; // Student not found
            } catch (error) {
                console.error('Error fetching data from API:', error);
                return null;
            }
        }

        function calculateGrade(marks) {
            const gradeA = parseFloat(schoolConfig.GradeAMin) || 90;
            const gradeB = parseFloat(schoolConfig.GradeBMin) || 80;
            const gradeC = parseFloat(schoolConfig.GradeCMin) || 70;
            const gradeD = parseFloat(schoolConfig.GradeDMin) || 60;
            const gradeE = parseFloat(schoolConfig.GradeEMin) || 50;
            
            if (marks >= gradeA) return 'A';
            else if (marks >= gradeB) return 'B';
            else if (marks >= gradeC) return 'C';
            else if (marks >= gradeD) return 'D';
            else if (marks >= gradeE) return 'E';
            else return 'F';
        }
        
        function getGradeClass(grade) {
            // Extract the base grade letter (A, B, C, D, E, F) from the grade
            // This handles grades with + symbols like A+, B+, etc.
            const baseGrade = grade.charAt(0);
            return `grade-${baseGrade}`;
        }

        function getGradeClass(grade) {
            // Extract the base grade letter (A, B, C, D, E, F) from the grade
            // This handles grades with + symbols like A+, B+, etc.
            const baseGrade = grade.charAt(0);
            return `grade-${baseGrade}`;
        }

        function displayResult(data, rollNumber) {
            // Set student info
            document.getElementById('studentName').textContent = data.name;
            document.getElementById('studentRoll').textContent = rollNumber;
            document.getElementById('studentClass').textContent = data.class;
            document.getElementById('examYear').textContent = "2024-25";
            document.getElementById('schoolName').textContent = data.school;
            document.getElementById('examName').textContent = data.examName;
            
            // Set new fields
            document.getElementById('studentDOB').textContent = data.dob;
            document.getElementById('fatherName').textContent = data.fatherName;
            document.getElementById('motherName').textContent = data.motherName;
            
            // Handle the signature image
            const signatureImg = document.getElementById('examInchargeSignature');
            
            // Function to check if image exists and display it
            function checkAndDisplayImage(imgSrc) {
                return new Promise((resolve) => {
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        signatureImg.src = imgSrc;
                        signatureImg.style.display = 'block';
                        resolve(true);
                    };
                    tempImg.onerror = function() {
                        resolve(false);
                    };
                    tempImg.src = imgSrc;
                });
            }
            
            // Try to load the custom signature or default signature
            async function handleSignature() {
                // Check if we have a custom signature
                if (data.examInchargeSignature && 
                    data.examInchargeSignature.trim() !== '' && 
                    data.examInchargeSignature !== 'Exam Incharge.png') {
                    
                    // Try the custom signature
                    const customSignatureWorks = await checkAndDisplayImage(data.examInchargeSignature);
                    if (customSignatureWorks) return;
                }
                
                // Try the default signature
                const defaultSignatureWorks = await checkAndDisplayImage('Exam Incharge.png');
                if (!defaultSignatureWorks) {
                    // If neither signature works, hide the image
                    signatureImg.style.display = 'none';
                }
            }
            
            // Call the function to handle signatures
            handleSignature();
            
            // Clear previous table rows
            const tableBody = document.getElementById('marksTableBody');
            tableBody.innerHTML = '';
            
            // Use the processed subjects if available, otherwise use the original subjects
            const subjectsToDisplay = data.processedSubjects || data.subjects;
            
            // Add subject rows with components
            subjectsToDisplay.forEach(subject => {
                // Create main subject row
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = subject.name;
                
                const maxMarksCell = document.createElement('td');
                maxMarksCell.textContent = subject.maxMarks;
                
                const obtainedCell = document.createElement('td');
                obtainedCell.textContent = subject.obtained;
                
                const gradeCell = document.createElement('td');
                gradeCell.textContent = subject.grade;
                gradeCell.className = getGradeClass(subject.grade);
                
                row.appendChild(nameCell);
                row.appendChild(maxMarksCell);
                row.appendChild(obtainedCell);
                row.appendChild(gradeCell);
                
                tableBody.appendChild(row);
                
                // If subject has components, add them as nested items
                if (subject.components && subject.components.length > 0) {
                    // Create a row for components
                    const componentsRow = document.createElement('tr');
                    const componentsCell = document.createElement('td');
                    componentsCell.colSpan = 4;
                    componentsCell.style.padding = '0 8px 8px 8px'; // Less padding to compact the display
                    componentsCell.style.borderTop = 'none'; // Remove top border for cleaner look
                    
                    const componentList = document.createElement('div');
                    componentList.className = 'component-list';
                    
                    // Add each component
                    subject.components.forEach(component => {
                        const componentItem = document.createElement('div');
                        componentItem.className = 'component-item';
                        
                        // Get the custom display name from our dictionary, or format nicely if not found
                        let displayName = window.componentDisplayNames[component.componentType] || 
                                         component.componentType.replace(/_/g, ' ');
                        
                        const componentNameSpan = document.createElement('span');
                        componentNameSpan.className = 'component-name';
                        componentNameSpan.textContent = displayName;
                        
                        const componentMarksSpan = document.createElement('span');
                        componentMarksSpan.className = 'component-marks';
                        // Format: marks (weightage)
                        componentMarksSpan.innerHTML = `${component.marks} <span class="component-weightage">(${component.weightage})</span>`;
                        
                        componentItem.appendChild(componentNameSpan);
                        componentItem.appendChild(componentMarksSpan);
                        componentList.appendChild(componentItem);
                    });
                    
                    componentsCell.appendChild(componentList);
                    componentsRow.appendChild(componentsCell);
                    tableBody.appendChild(componentsRow);
                }
            });
            
            // Set summary information
            document.getElementById('totalObtained').textContent = data.totalObtained;
            document.getElementById('totalMax').textContent = data.totalMarks;
            document.getElementById('percentage').textContent = data.percentage;
            document.getElementById('cgpa').textContent = data.cgpa;
            
            // Set result
            const resultStatus = document.getElementById('resultStatus');
            resultStatus.textContent = data.result;
            resultStatus.className = data.result === 'PASS' ? 'pass' : 'fail';
        }

        function fetchResult() {
            const rollNumber = document.getElementById('rollNumber').value;
            const resultCard = document.getElementById('resultCard');
            const errorMessage = document.getElementById('errorMessage');
            
            // Reset display
            resultCard.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Reset detailed view flag
            useDetailedView = false;
            
            // Validate input
            if (!rollNumber.trim()) {
                errorMessage.textContent = "Please enter an admission number";
                errorMessage.style.display = 'block';
                return;
            }
            
            // Fetch data from backend
            fetchStudentData(rollNumber).then(data => {
                if (data) {
                    displayResult(data, rollNumber);
                    resultCard.style.display = 'block';
                } else {
                    errorMessage.style.display = 'block';
                }
            });
        }
        
        function printResult() {
            // Make sure the result card is visible
            const resultCard = document.getElementById('resultCard');
            if (resultCard.style.display === 'none') {
                alert('Please search for a student result first');
                return;
            }
            
            // Check if we need landscape mode (for detailed table)
            const detailedTable = document.getElementById('detailedTableContainer');
            if (detailedTable.style.display !== 'none') {
                document.body.classList.add('print-landscape');
            } else {
                document.body.classList.remove('print-landscape');
            }
            
            // Print the page
            window.print();
        }
        
        // Add event listener for Enter key on roll number input
        document.getElementById('rollNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchResult();
            }
        });
    </script>
</body>
</html>
